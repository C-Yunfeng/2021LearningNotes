### 一、流程图

- [流程图](https://zhuanlan.zhihu.com/p/114374961)：

  ![img](https://pic2.zhimg.com/80/v2-004c99b31f7396162a9b4346e5fe1629_720w.jpg)

- [流程图](https://mp.weixin.qq.com/s/JIWx913atMxznf2AhEFoow)：

  ![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210328112422.png)

- `8`案例流程图：

  ![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210327123914.png)

  

---



### 二、详细流程

- 定义：

  > 追踪是什么因素影响了指标的变动，并根据试验结果作出决策

- 目的：

  > 主要是为了收集用户对实验的反馈

- 方法：

  > 方法则是查看不同分组下用户数据指标和用户行为的对比和变化

#### 1. 实验前

##### 1. ABT的使用场景

换句话说：什么时候做A/B test？A/B test的限制条件？

1. ABT的使用场景：

     > - 上线一个新功能，看对指标有多大提高
     >
     > - 衡量一个功能的重要程度【比如：不同红包活动对DAU的影响】
     > - 阻止扯皮

2. 什么时候不能用A/B test？

    > - 没有清晰的比较方案，
    > - 多变量对指标的影响（不能确定结果是哪个因素变化导致的）
    > - 功能要对应：比如A版本的用户想给B版本的用户留言，而B版本的用户没有这个功能。
    > - 裂变实验？？？
    
> 什么时候可以不用ABT，见“ABT的成本问题”

    > `[7]`：需要注意的是，ABT并不完全适用于所有的产品，因为 ABT的结果需要大量数据支撑，日流量越大的网站得出结果越准确。通常来说，我们建议在进行 A/B 测试时，能够保证每个版本的日流量在 1000 个 UV 以上，否则试验周期将会很长，或很难获得准确（结果收敛）的数据结果推论。

##### 2. 做出假设

> 指标结果、确定参数α、β、容忍误差。其中α和β是和其他同事一起讨论的结果。

##### 3. 确定指标

> 核心指标（结果指标）、过程指标、观察指标
>
> 如点击率，转化率，使用时长，GMV，客单价
>
> ![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210328111336.png)

##### 4. 确定数据是否可收集



##### 5. 分流（抽样）

> magicnumber7
>
> ![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210418130054.png)

1. 根据业务场景确定分流方案

   > 根据所要进行测试的场景可以进行多种分流：【考虑风险】
   >
   > - 不影响用户体验——均匀分流，
   > - 不确定性强——小流量新样本
   > - 收益最大化——大流量试验，小流量评估ROI？？？（小流量怎么评估，是贯穿层吗）
   >
   > [携程ABT](https://zhuanlan.zhihu.com/p/25685006)的数据流和分流计算

2. 最低样本量的计算

   > - 比例指标，如留存率、点击率、渗透率：
   >
   > - 数值指标，如人均使用时长、人均vv：
   >
   > - 统计学计算：
   >
   >   一般有“两个总体均值”和“两个总体比例”两种情况。
   >
   >   $$n_1=n_2=\frac{z_{\alpha/2}^2(\sigma_1^2+\sigma_2^2)}{E^2}$$，$n_1=n_2=\frac{z_{\alpha/2}^2[\pi_1(1-\pi_1)][\pi_2(1-\pi_2)]}{E^2}$
   >
   >   在实际场景中，常有$\alpha,\beta,E$三个参数，公式为
   >
   >   $n=\frac{\sigma^2}{\Delta^2}(z_{\alpha/2}^2+z_{\beta}^2)$，
   >
   >   具体推导方法：[计算样本量](https://www.youtube.com/watch?v=JEAsoUrX6KQ&ab_channel=DataInterviewPro)，或如图所示，假设取$2\sigma$，$z_{\alpha/2}=-1./96,z_{\beta}=-0.84$，那么最后就是约为16。
   >
   >   ![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210319170008.png)

3. 分流分桶原理

   > 幂等-均匀-并行（一致，均匀）
   >
   > 分流策略要关注随机性、体验一致性：即实验本身是不存在幸存者差异的，且一个用户多次访问同一个实验的结果需要一致（比如新人红包几次进来的补贴金额不一样会有额外问题），所以分流的hash算法需要了解一下大概的实现逻辑；
   
   > [正交和互斥的区别](https://juejin.cn/post/6844903850059497480)：
   >
   > - **互斥**。指两个实验流量独立，用户只能进入其中一个实验。一般是针对于同一流量层上的实验而言，比如图文混排列表实验和纯图列表实验，同一个用户在同一时刻只能看到一个实验，所以他们互斥。
   >
   > - **正交**。正交是指用户进入所有的实验之间没有必然关系。比如进入实验 1 中 a 版本的用户再进行其它实验时也是均匀分布的，而不是集中在某一块区间内。
   
   > - 错误方法：userID哈希，孤立实验。【流量饥饿】
   >
   >   问题：长期交叉连续时，一次性效率低（新实验要重新分）、长期有偏（桶间差异变大）
   >
   > - 正交分层：可重叠分层分桶【不同实验不相关，每层不同的随机分桶，确保不同层之间流量正交】
   >
   >   - 确定Layer，TAG：DeviceID、IMSI
   >   - Hash
   >   - Hash(Layer，Tag)%100确定分桶
   >   - 完成分桶后可以流量筛选
   >
   > - 改进方法：无限分层
   >
   > - 辛普森悖论，不同方案所抽取的用户应该同分布，而且能够代表总体的分布，用哈希函数？？？
   
4. 自适应分组？？？

5. 流量分组的顺序图

   > 功能配置和分组配置的信息传递与存储过程，`[1]`：
   >
   > ![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210324205724.png)

6. [实验开关与分组信息传递](https://yangwenbo.com/articles/abtest-experiments-switch.html)

   > - 开关与分组信息传递![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210327122048.png)
   >
   > - 分组信息存储：正确做法是在关键日志中添加分组信息的字段
   > - 分组编码（命名方式）豪放派、婉约派、、、

7. [辛普森悖论详解](https://www.jianshu.com/p/e1891d7242ff)

   > 简单地说，就是两个相差较多的分组数据相加时，在分组比较中占优势的一方，会在总评中处于劣势

   > ①一般都是遭遇比率类的问题；
   >
   > ②辛普森悖论和样本大小存在一定关系；
   >
   > ③辛普森悖论其实受“众数”影响较大，众数的比率指标往往反映了整体的比率指标情况，那么在分析决策时候，我们要选择的就是，是否要信赖分组中“众数群体”的表现，作为决策指引；
   >
   > ④辛普森悖论跟混淆变量有关，需要控制变量，找到实际的相关因素，拆开表面数据；
   >
   > ⑤方法上可以多用散点图来观察问题。
   >
   > 分层试验，交叉试验，定向试验是我们规避辛普森悖论的有力工具。
   >
   > [！可视化辛普森悖论](https://zhuanlan.zhihu.com/p/43799488)，
   >
   > **在试验设计上**，如果我们觉得某两个变量对试验结果都有影响，那我们就应该把这两个变量放在同一层进行互斥试验，不要让一个变量的试验动态影响另一个变量的检验。如果我们觉得一个试验可能会对新老客户产生完全不同的影响，那么就应该对新客户和老客户分别展开定向试验，观察结论。
   >
   > **在试验实施上**，对试验结果我们要积极的进行多维度的细分分析，除了总体对比，也看一看对细分受众群体的试验结果，不要以偏盖全，也不要以全盖偏。一个试验版本提升了总体活跃度，但是可能降低了年轻用户的活跃度，那么这个试验版本是不是更好呢。一个试验版本提升总营收0.1%，似乎不起眼，但是可能上海地区的年轻女性 iPhone 用户的购买率提升了20%，这个试验经验就很有价值了。

- [ ] ` 使用前的准备工作？？？AA test在之前还是之后？？？`

  如果有：数据损坏、数据混乱，抽样不随机等情况，需要先做AA test。即相同的方案在不同用户上的体验，以确定用户抽样的随机性



##### 6. 埋点设计（统一见后面）



---



#### 2. 实验中

##### 1. 埋点数据收集（见后面）

##### 2. 检验方法

> - 卡方检验？？？
> - t检验

##### 3. 什么时候停止

> 理想情况下，根据样本量确定：比如样本量至少10000，DAU有500，则需要20天

> 但实际情况下可能会花费更长的时间，那具体要延长多久？？？
>
> - 结果显著，至少保证95%的可信度
>
> - 样本量够大 
>
> - 时间够长
>
> - 曲线平坦

##### 5. 实验时用户的不可控行为





---





#### 3. 评估

##### 1. 如何看图表

> `[8]`抓大放小，指标拆解

##### 2. 非理想显著情况

1. 试验结果统计显著，实际不显著，为什么

   > 一个可能原因：样本量太大，和总量差别较小。比如APP启动时间优化了0.001秒，在统计上可能是显著的，但用户感知不到。没有太大的实际意义。

2. 试验结果统计不显著，怎么判断收益

    > 进行指标拆解，如果每日实验组都优于对照组，即使统计不显著，也认为在这样的一个观测周期内，实验组的关键指标是优于对照组的，即可以上线

4. 如果核心指标显著提升，一定能上线吗

   > 如：提高帧率，但会增加耗电。一个方面的优化可能会导致另一个方面的劣化。性能提升时也可能对其他部门造成影响，从而影响收入。



##### 3. ABT的有效性 

> 样本数量：太少，从小到大
>
> 辛普森悖论
>
> - 样本质量（分布）：正交分层
> - 发版造成指标波动：不同版本用户占比不同，导致总效果反转https://yangwenbo.com/articles/abtest-traffic-orthogonality.html
>
> 新奇效应
>
> 结果可信度：AAT，实验反转，https://zhuanlan.zhihu.com/p/116002163

##### 4. ABT的成本问题

> 开ab测试是需要成本的，你不觉得每一次都开ab试验，成本会过高吗？
>
> 如果只是验证一个小按钮的改动，可以在页面上设置一个开关，用户可以自行决定用哪一种方式。最后可以根据用户对开关的操作判断更倾向于哪一种形式。【也可以做一些问卷？需要吗？全量调查】





##### 5. ！！！扩缩容量

> `[6]`在实际线上运行ab测试的时候，我们经常需要针对某个实验参数做流量的扩量或者缩量，比如三个实验参数A、B、C，线上数据发现A的指标相对最好，我们会逐步的针对C扩量，其他做相应的缩量。

> 放量的前提：`2.3什么时候停止`

> 放量的方式：
>
> 常见的放量方式有两种，**流量开放以及实验推广**。流量开放包含了实验内对照组和实验组流量的切分，也可在源头再增加样本。实验推广，则是将此实验在其他特征、行为的群体中推广。

> 如何根据ABT结果判断是否增加样本量？？？？（科学严谨准确的描述！）

> 灰度发布的验证结果并不能替代ABT，因为不能实现精准分流？？？



##### 6. 再实验/放弃

> 再实验的原因，从效果的次序来看是：**无法肯定是否有效果->无效果->效果不明显->负反馈。**负反馈如果影响了核心流程，则应考虑终止实验。



---



#### 4. 实验后

##### 1. 埋点下线

> `[8]`的埋点下线

##### 2. [灰度发布](https://yangwenbo.com/articles/abtest-gated-launch.html)

> 基于 ABTest 的灰度发布，很多情况下可以简化服务的部署和回滚操作，也保证了用户在灰度上线期间的体验稳定性。



---







#### 5. 埋点

> 数据埋点一般时伴随新的业务/功能产生的，因为这是一个多部门复合型的工作。
>
> 埋点设计：
>
> - 产品经理明确新业务的需求、UI设计图，后续关注的一些业务点，整理成文档，数据分析师完成**埋点设计**，埋点文档反馈给产品经理和开发，最后结果会返回给数据分析师，用于**埋点验证**。
>
> 埋点验证：
>
> - 明确业务背景【比如产品经理要策划训练营活动，搞清楚训练营有哪些活动入口，用户进入后会经历哪些环节，是不是存在漏斗转化，活动本身有哪些需要关注的指标，活动最终会作用于哪些北极星指标】就决定了设计埋点时应该往哪些方向考虑。埋点不能太多，不能太少。
>
> - 规范埋点的命名，如图所示
>
>   ![](https://blogjallery.oss-cn-beijing.aliyuncs.com/img/20210319213510.png)
>
>   不同系统的埋点开发不同
>
> 埋点验收：
>
> - 需要触发埋点的环节，所有的埋点是否都能正常上报
> - 上报的埋点中，是否包括需要的参数值，拼写是否正确





#### 6. 复杂方案

1. 多个活动同时进行，用无活动贯穿层
2. 对比方案过去的效果，过去贯穿层





---



### 三、平台方案

#### 1. 美团

![preview](https://pic4.zhimg.com/v2-cf02dce7b64022787de10b70e9254ccf_r.jpg)

#### 2. 马蜂窝

![preview](https://pic4.zhimg.com/v2-d9f2fd195910bbaf944152c0089bc263_r.jpg)



#### 3. 沪江

![img](https://pic3.zhimg.com/80/v2-c42d1b912abe74222750fe501612a6f6_720w.jpg)





### 四、参考资料

#### 文章

- [ ] [1 阿里巴巴-AB测试和灰度发布平台 架构设计和实践](http://topic.it168.com/factory/adc2013/doc/oucheng.pdf)【】
- [x] [2 ！美团点评效果广告实验配置平台的设计与实现](https://tech.meituan.com/2019/11/28/advertising-performance-experiment-configuration-platform.html)【分流模型，水平垂直，Hash流程，回滚模型，】
- [ ] [3 以ABtest平台为例（下）-需求文档](https://zhuanlan.zhihu.com/p/114497160)【】
- [ ] [4 Twitter 的 A/B 测试实践（一）：为什么要测试以及测试的意义 ](https://www.infoq.cn/article/twitter-ab-test-practise-part01/)【】
- [ ] [5 abtest 系统设计汇总](https://qiankunli.github.io/2018/06/27/abtest.html)【扩容，】
- [ ] [6 沪江ABTest测试平台实践](https://juejin.cn/post/6844903629619462158#comment)【实验指标：订单转化、留存（次日留存、三日留存、七日留存等）、点击转化率】【感觉像抄的啊】
- [ ] [7 马蜂窝ABTest多层分流系统的设计与实现](https://juejin.cn/post/6844903850059497480)【多级缓存策略】
- [ ] [8 ！携程机票的ABTest实践](https://zhuanlan.zhihu.com/p/25685006)【】
- [ ] [9 什么是ABT](https://www.zhihu.com/question/20045543/answer/1103961403)【腾讯技术、贯穿层、推荐系统】
- [ ] [10 ！ABTest 平台设计 - 实验开关和分组信息传递](https://yangwenbo.com/articles/abtest-experiments-switch.html)【功能配置，分组配置，分组编码，配置存储】
- [ ] [A/B测试(A/B试验)的概述、原理、公式推导、Python实现和应用](https://zhuanlan.zhihu.com/p/346602966)
- [ ] /How Not To Run an A/B Testhttps://www.evanmiller.org/how-not-to-run-an-ab-test.html
- [ ] /A/B 测试有什么局限性？https://www.zhihu.com/question/19631253
- [ ] /可视化Type I and Type II errors, β, α, *p*-values, power and effect sizes https://rpsychologist.com/d3/nhst/
- [ ] /t分布于正态分布https://pic4.zhimg.com/v2-68f41a34cee4b4d9c6bdae595fee3657_r.jpg
- [ ] ！几个ABtest工具https://www.evanmiller.org/ab-testing/
- [ ] /假设检验基础：α错误，β错误，样本容量，效应量的关系简介https://zhuanlan.zhihu.com/p/133448119
- [ ] /如何设计一个 A/B test --来自腾讯数据分析师的分享https://blog.csdn.net/weixin_41744624/article/details/110231104





- [ ] https://zhuanlan.zhihu.com/p/36384858，加入新AB实验怎么分配流量
- [ ] https://zhuanlan.zhihu.com/p/159483869，计算器参数解释
- [ ] 微信的机器学习与人工智能应用实践，https://www.infoq.cn/article/wechat-machine-learning-ai-practice/











----------------------------------

